---
import { languages } from "@utils/ui";
import Icon from "./icons/Icon.astro";
---

<div class="hs-dropdown relative inline-flex">
  <button
    id="hs-dropdown-default"
    type="button"
    aria-label="Cambiar idioma"
    title="Cambiar idioma"
    class="hs-dropdown-toggle inline-flex items-center gap-x-2 rounded-lg px-1.5 py-1.5 text-sm font-medium text-neutral-600 outline-none ring-zinc-500 transition duration-300 hover:bg-neutral-200 hover:text-red-600 dark:border-neutral-700 dark:text-neutral-400 dark:ring-zinc-200 dark:hover:bg-neutral-700 dark:hover:text-red-500 dark:focus:outline-none"
  >
    <Icon name="earth" />
    <svg
      class="size-4 hs-dropdown-open:rotate-180"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"><path d="m6 9 6 6 6-6"></path></svg
    >
  </button>

  <div
    class="hs-dropdown-menu duration left-[20%]! top-[98%]! mt-2 hidden transform-none! rounded-lg bg-neutral-50 p-2 opacity-0 shadow-md transition-[opacity,margin] before:absolute before:-top-4 before:start-0 before:h-4 before:w-full after:absolute after:-bottom-4 after:start-0 after:h-4 after:w-full hs-dropdown-open:opacity-100 dark:divide-neutral-700 dark:border dark:border-neutral-700 dark:bg-neutral-800 md:left-[90%]! md:top-[80%]!"
    aria-labelledby="hs-dropdown-hover-event"
  >
    {
      Object.entries(languages).map(([lang, label]) => (
        <a
          class="flex items-center gap-x-3.5 rounded-lg px-3 py-2 text-sm text-neutral-800 hover:bg-neutral-100 focus:bg-neutral-100 focus:outline-none dark:text-neutral-400 dark:hover:bg-neutral-700 dark:hover:text-neutral-300 dark:focus:bg-neutral-700"
          href={lang === "es" ? "/" : `/${lang}/`}
        >
          {label}
        </a>
      ))
    }
  </div>
</div>

<script>
  // Configuración exclusiva para Español (es) e Inglés (en)
  type TLanguage = "es" | "en";
  const languages: TLanguage[] = ["es", "en"];

  document.addEventListener("DOMContentLoaded", function () {
    const languageLinks = document.querySelectorAll(".hs-dropdown-menu[aria-labelledby='hs-dropdown-hover-event'] a");
    
    languageLinks.forEach((element) => {
      const link = element as HTMLAnchorElement;
      
      link.addEventListener("click", function (event) {
        event.preventDefault();
        
        // Identificar el idioma destino desde el href
        const href = link.getAttribute("href");
        const targetLang = (href === "/" || href === "") ? "es" : href?.replace(/\//g, "") as TLanguage;

        const url = new URL(window.location.href);
        
        // Limpiar la ruta actual de cualquier prefijo de idioma (es o en)
        const pathParts = url.pathname.split("/").filter(part => part !== "");
        
        // Si el primer segmento es un idioma soportado, lo removemos para obtener la ruta "limpia"
        if (languages.includes(pathParts[0] as TLanguage)) {
          pathParts.shift();
        }
        
        const cleanPath = pathParts.join("/");

        let newPath = "";
        // Construir la nueva ruta: si es inglés va a /en/ruta, si es español va a /ruta
        if (targetLang === "en") {
          newPath = `/en/${cleanPath}`;
        } else {
          newPath = `/${cleanPath}`;
        }

        // Normalizar barras diagonales
        newPath = newPath.replace(/\/+/g, "/");
        if (newPath === "") newPath = "/";
        
        // Ejecutar redirección manteniendo parámetros de búsqueda (ej. ?ref=google)
        window.location.href = `${url.origin}${newPath}${url.search}`;
      });
    });
  });
</script>